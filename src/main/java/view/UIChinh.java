/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/Application.java to edit this template
 */
package view;

import java.awt.BorderLayout;
import model.KhachHang;
import model.QuanLyKhachHangService;
import util.TaiAnhGamePlay;
import util.TextFileStorage;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.event.WindowEvent;
import java.util.HashMap;
import javax.swing.BorderFactory;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.OverlayLayout;
import javax.swing.SwingUtilities;
import model.GameTimeManager;
import util.SoundManager;

/**
 *
 * @author lap top
 */
public class UIChinh extends javax.swing.JFrame {

    private TextFileStorage.PlayerData playerData;
    private GameTimeManager gameTimeManager;
    private long gameStartTime;
    private final float TIME_SCALE = 0.1f;
    private QuanLyKhachHangService khachHangService;
    private KhachHang khachHangMoiTamThoi;
    private KichBanNgayDauTien kichBanNgayDau;

    public UIChinh() {
        initComponents();
        customizeUI();
        SoundManager.initialize();
        SoundManager.setMainUIReference(this);
        SoundManager.playBGM(); // B·∫Øt ƒë·∫ßu ph√°t nh·∫°c n·ªÅn
        setupPanelBackground(jPanel1);
        // Th√™m listener ƒë·ªÉ d·ªçn d·∫πp khi ·ª©ng d·ª•ng ƒë√≥ng
        SoundManager.addAppCloseListener(() -> {
            // Code d·ªçn d·∫πp temp files ho·∫∑c resources kh√°c
            System.out.println("·ª®ng d·ª•ng ƒëang ƒë√≥ng, d·ªçn d·∫πp t√†i nguy√™n...");
        });
        loadPlayerData(); // Ph·∫£i g·ªçi tr∆∞·ªõc
        khachHangService = new QuanLyKhachHangService(playerData); // G·ªçi sau khi c√≥ playerData
        updateUI();
        initGameTimeManager();
        loadRandomImageToButton();

        Opening opening = new Opening(this);
        kichBanNgayDau = new KichBanNgayDauTien(this);
        int savedDayCount = KichBanNgayDauTien.getCurrentDayCount();
        opening.startOpeningSequence();
    }

    @Override
    protected void processWindowEvent(WindowEvent e) {
        if (e.getID() == WindowEvent.WINDOW_CLOSING) {
            // D·ª´ng timer khi ƒë√≥ng ·ª©ng d·ª•ng
            if (gameTimeManager != null && gameTimeManager.isTimerRunning()) {
                gameTimeManager.stopTimer();
            }
            // D·ªçn d·∫πp SoundManager khi ·ª©ng d·ª•ng ƒë√≥ng
            SoundManager.cleanup();
        }
        super.processWindowEvent(e);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel2 = new javax.swing.JPanel();
        jPanel3 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        btnAnh = new javax.swing.JButton();
        jButton1 = new javax.swing.JButton();
        jPanel5 = new javax.swing.JPanel();
        btnTTKH = new javax.swing.JButton();
        btnKHTrongNgay = new javax.swing.JButton();
        jLabel7 = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        btnBan = new javax.swing.JButton();
        btnKhong = new javax.swing.JButton();
        menuBar = new javax.swing.JMenuBar();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("c·ª≠a h√†ng hoang");

        jPanel2.setBackground(new java.awt.Color(204, 255, 255));
        jPanel2.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));

        jLabel1.setFont(new java.awt.Font("Arial", 1, 12)); // NOI18N
        jLabel1.setText("T√™n:");

        jLabel2.setFont(new java.awt.Font("Arial", 2, 12)); // NOI18N
        jLabel2.setText("Player");

        jLabel3.setFont(new java.awt.Font("Arial", 1, 12)); // NOI18N
        jLabel3.setText("Th·ªùi gian:");

        jLabel4.setFont(new java.awt.Font("Arial", 0, 12)); // NOI18N
        jLabel4.setText("00:00");

        jLabel5.setFont(new java.awt.Font("Arial", 1, 12)); // NOI18N
        jLabel5.setText("Ti·ªÅn:");

        jLabel6.setFont(new java.awt.Font("Arial", 0, 12)); // NOI18N
        jLabel6.setText("0000");

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel2)
                .addGap(246, 246, 246)
                .addComponent(jLabel3, javax.swing.GroupLayout.DEFAULT_SIZE, 69, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel4, javax.swing.GroupLayout.DEFAULT_SIZE, 44, Short.MAX_VALUE)
                .addGap(206, 206, 206)
                .addComponent(jLabel5)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel6)
                .addGap(23, 23, 23))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jLabel2)
                    .addComponent(jLabel3)
                    .addComponent(jLabel5)
                    .addComponent(jLabel6, javax.swing.GroupLayout.PREFERRED_SIZE, 16, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel4))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jPanel1.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));

        btnAnh.setFont(new java.awt.Font("Arial", 0, 12)); // NOI18N
        btnAnh.setText("jButton2");
        btnAnh.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAnhActionPerformed(evt);
            }
        });

        jButton1.setFont(new java.awt.Font("Arial", 1, 12)); // NOI18N
        jButton1.setText("C·ª¨A H√ÄNG TI·ªÜN L·ª¢I");
        jButton1.setActionCommand("btnShop");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(btnAnh, javax.swing.GroupLayout.PREFERRED_SIZE, 252, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(241, 241, 241))
            .addComponent(jButton1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 29, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(btnAnh, javax.swing.GroupLayout.PREFERRED_SIZE, 279, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        btnTTKH.setFont(new java.awt.Font("Arial", 0, 12)); // NOI18N
        btnTTKH.setText("Th√¥ng tin KH");
        btnTTKH.setToolTipText("");
        btnTTKH.setActionCommand("btnThongTinKH");
        btnTTKH.setMaximumSize(new java.awt.Dimension(270, 150));
        btnTTKH.setPreferredSize(new java.awt.Dimension(270, 150));
        btnTTKH.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTTKHActionPerformed(evt);
            }
        });

        btnKHTrongNgay.setFont(new java.awt.Font("Arial", 0, 12)); // NOI18N
        btnKHTrongNgay.setText("KH trong ng√†y");
        btnKHTrongNgay.setToolTipText("");
        btnKHTrongNgay.setActionCommand("btnKHTrongNgay");
        btnKHTrongNgay.setMaximumSize(new java.awt.Dimension(270, 150));
        btnKHTrongNgay.setName("btnKHTrongNgay"); // NOI18N
        btnKHTrongNgay.setPreferredSize(new java.awt.Dimension(270, 150));
        btnKHTrongNgay.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnKHTrongNgayActionPerformed(evt);
            }
        });

        jLabel7.setFont(new java.awt.Font("Arial", 1, 14)); // NOI18N
        jLabel7.setText("ƒêi·ªÉm Tinh Th·∫ßn Hi·ªán T·∫°i");
        jLabel7.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));

        jLabel8.setFont(new java.awt.Font("Arial", 0, 18)); // NOI18N
        jLabel8.setText("100");
        jLabel8.setBorder(javax.swing.BorderFactory.createEtchedBorder(new java.awt.Color(255, 102, 0), null));

        btnBan.setFont(new java.awt.Font("Arial", 0, 12)); // NOI18N
        btnBan.setText("B√ÅN");
        btnBan.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnBanActionPerformed(evt);
            }
        });

        btnKhong.setFont(new java.awt.Font("Arial", 0, 12)); // NOI18N
        btnKhong.setText("KH√îNG");
        btnKhong.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnKhongActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel5Layout = new javax.swing.GroupLayout(jPanel5);
        jPanel5.setLayout(jPanel5Layout);
        jPanel5Layout.setHorizontalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel5Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(btnTTKH, javax.swing.GroupLayout.PREFERRED_SIZE, 270, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel5Layout.createSequentialGroup()
                        .addGap(18, 18, 18)
                        .addComponent(btnBan, javax.swing.GroupLayout.PREFERRED_SIZE, 78, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(40, 40, 40)
                        .addComponent(btnKhong, javax.swing.GroupLayout.PREFERRED_SIZE, 74, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 26, Short.MAX_VALUE))
                    .addGroup(jPanel5Layout.createSequentialGroup()
                        .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(jPanel5Layout.createSequentialGroup()
                                .addGap(100, 100, 100)
                                .addComponent(jLabel8))
                            .addGroup(jPanel5Layout.createSequentialGroup()
                                .addGap(29, 29, 29)
                                .addComponent(jLabel7)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addComponent(btnKHTrongNgay, javax.swing.GroupLayout.PREFERRED_SIZE, 221, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
        jPanel5Layout.setVerticalGroup(
            jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel5Layout.createSequentialGroup()
                .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(jPanel5Layout.createSequentialGroup()
                        .addGap(26, 26, 26)
                        .addComponent(jLabel7)
                        .addGap(18, 18, 18)
                        .addComponent(jLabel8, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(btnKhong, javax.swing.GroupLayout.PREFERRED_SIZE, 42, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btnBan, javax.swing.GroupLayout.PREFERRED_SIZE, 42, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addGroup(javax.swing.GroupLayout.Alignment.LEADING, jPanel5Layout.createSequentialGroup()
                        .addContainerGap()
                        .addGroup(jPanel5Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(btnKHTrongNgay, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                            .addComponent(btnTTKH, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE))))
                .addContainerGap())
        );

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel5, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGap(47, 47, 47)
                .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel5, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );

        setJMenuBar(menuBar);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnKhongActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnKhongActionPerformed
        if (khachHangMoiTamThoi != null) {
            khachHangService.setKhachHangHienTai(khachHangMoiTamThoi);

            // S·ª¨A D√íNG N√ÄY: th√™m playerData.inventory
            boolean result = khachHangService.xuLyBanHang(false, playerData.inventory);
            if (result) {
                updateUI();
                // QUAN TR·ªåNG: Reset k√≠ch th∆∞·ªõc tr∆∞·ªõc khi load ·∫£nh m·ªõi
                fixButtonSize(btnAnh, 252, 301);

                loadRandomImageToButton();
                khachHangMoiTamThoi = null;

            }
            jPanel2.setPreferredSize(new Dimension(550, 600));
        }
    }//GEN-LAST:event_btnKhongActionPerformed

    private void btnBanActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnBanActionPerformed
        if (khachHangMoiTamThoi != null) {
            khachHangService.setKhachHangHienTai(khachHangMoiTamThoi);

            if (!khachHangService.kiemTraCoTheBan(playerData.inventory)) {
                JOptionPane.showMessageDialog(this,
                        "Kh√¥ng th·ªÉ b√°n! B·∫°n kh√¥ng c√≥ ƒë·ªß v·∫≠t ph·∫©m m√† kh√°ch h√†ng y√™u c·∫ßu.",
                        "Kh√¥ng th·ªÉ b√°n",
                        JOptionPane.WARNING_MESSAGE);
                return;
            }

            boolean result = khachHangService.xuLyBanHang(true, playerData.inventory);
            if (result) {
                // C·∫¨P NH·∫¨T TI·ªÄN NGAY L·∫¨P T·ª®C
                loadPlayerData();
                updateUI();
                // QUAN TR·ªåNG: Reset k√≠ch th∆∞·ªõc tr∆∞·ªõc khi load ·∫£nh m·ªõi
                fixButtonSize(btnAnh, 252, 301);
                loadRandomImageToButton();
                khachHangMoiTamThoi = null;

                // PH√ÅT √ÇM THANH TH√ÄNH C√îNG
                SoundManager.playSuccessSound();
            }
        }
        jPanel2.setPreferredSize(new Dimension(550, 600));
    }//GEN-LAST:event_btnBanActionPerformed

    private void btnKHTrongNgayActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnKHTrongNgayActionPerformed
        try {
            SwingUtilities.invokeLater(() -> {
                UiKhachHang giaoDienKH = new UiKhachHang();
                giaoDienKH.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
                giaoDienKH.setVisible(true);
            });
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "L·ªói khi m·ªü giao di·ªán kh√°ch h√†ng: " + e.getMessage(),
                    "L·ªói", JOptionPane.ERROR_MESSAGE);
        }
    }//GEN-LAST:event_btnKHTrongNgayActionPerformed

    private void btnTTKHActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTTKHActionPerformed
        if (khachHangMoiTamThoi != null) {
            // C·∫≠p nh·∫≠t kh√°ch h√†ng hi·ªán t·∫°i trong service
            khachHangService.setKhachHangHienTai(khachHangMoiTamThoi);

            // L·∫•y th√¥ng tin kh√°ch h√†ng k√®m y√™u c·∫ßu d·ª±a tr√™n inventory hi·ªán t·∫°i
            String thongTin = khachHangMoiTamThoi.layThongTin();
            String yeuCau = khachHangService.layYeuCauKhachHangHienTai();

            // Ki·ªÉm tra xem ng∆∞·ªùi ch∆°i c√≥ ƒë·ªß v·∫≠t ph·∫©m kh√¥ng
            String trangThai = khachHangService.kiemTraDuVatPham(playerData.inventory);

            // Hi·ªÉn th·ªã th√¥ng tin ƒë·∫ßy ƒë·ªß
            String thongTinDayDu = thongTin + "\n\nY√äU C·∫¶U: " + yeuCau + "\n\nTR·∫†NG TH√ÅI: " + trangThai;

            JOptionPane.showMessageDialog(this, thongTinDayDu, "Th√¥ng Tin Kh√°ch H√†ng", JOptionPane.INFORMATION_MESSAGE);
        } else {
            JOptionPane.showMessageDialog(this, "Ch∆∞a c√≥ kh√°ch h√†ng n√†o!", "L·ªói", JOptionPane.WARNING_MESSAGE);
        }
    }//GEN-LAST:event_btnTTKHActionPerformed

    private void btnAnhActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAnhActionPerformed
        // Ch·ªâ t·∫°o kh√°ch h√†ng m·ªõi n·∫øu kh√¥ng c√≥ kh√°ch h√†ng t·∫°m th·ªùi n√†o ƒëang ch·ªù
        if (khachHangMoiTamThoi == null) {
            // T·∫°o kh√°ch h√†ng m·ªõi v√† g√°n v√†o bi·∫øn t·∫°m th·ªùi
            khachHangMoiTamThoi = khachHangService.taoKhachHangMoi();

            if (khachHangMoiTamThoi != null) {
                String yeuCau = khachHangMoiTamThoi.getTen() + " n√≥i: " + khachHangService.layYeuCauKhachHangHienTai();

                // Hi·ªÉn th·ªã y√™u c·∫ßu kh√°ch h√†ng qua JOptionPane
                JOptionPane.showMessageDialog(
                        this,
                        yeuCau,
                        "Kh√°ch h√†ng m·ªõi",
                        JOptionPane.INFORMATION_MESSAGE
                );

                // T·∫¢I ·∫¢NH THEO GI·ªöI T√çNH C·ª¶A KH√ÅCH H√ÄNG
                loadRandomImageToButton();
            }
        } else {
            // Th√¥ng b√°o cho ng∆∞·ªùi d√πng r·∫±ng c√≥ kh√°ch h√†ng ƒëang ch·ªù
            JOptionPane.showMessageDialog(this, "C√≥ m·ªôt kh√°ch h√†ng ƒëang ch·ªù r·ªìi!", "L·ªói", JOptionPane.WARNING_MESSAGE);
        }
    }//GEN-LAST:event_btnAnhActionPerformed

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        this.setEnabled(false);

        SwingUtilities.invokeLater(() -> {
            UiPhuBanHang shop = new UiPhuBanHang(() -> {
                SwingUtilities.invokeLater(() -> {
                    loadPlayerData();
                    updateUI();
                    UIChinh.this.setEnabled(true);
                    UIChinh.this.toFront();
                });
            });

            shop.setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
            shop.setVisible(true);
        });
    }

    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(() -> {
            new UIChinh().setVisible(true);
        });
    }

    private void loadPlayerData() {
        playerData = TextFileStorage.loadPlayerData();
        if (playerData.money <= 0) {
            playerData.money = 1000;
            playerData.mentalPoints = 100;
            playerData.inventory = new HashMap<>();
        }
    }

    private void updateUI() {
        jLabel6.setText(String.valueOf(playerData.money));
        jLabel8.setText(String.valueOf(playerData.mentalPoints));
    }//GEN-LAST:event_jButton1ActionPerformed

    /**
     * @param args the command line arguments
     */

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAnh;
    private javax.swing.JButton btnBan;
    private javax.swing.JButton btnKHTrongNgay;
    private javax.swing.JButton btnKhong;
    private javax.swing.JButton btnTTKH;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JMenuBar menuBar;
    // End of variables declaration//GEN-END:variables

    private void customizeUI() {
        JPanel[] panels = {jPanel1, jPanel2, jPanel3, jPanel5};
        JLabel[] labels = {jLabel1, jLabel2, jLabel3, jLabel4, jLabel5, jLabel6, jLabel7, jLabel8};
        JButton[] specialButtons = {btnKHTrongNgay, jButton1}; // C√°c n√∫t m√†u ƒë·ªè m√°u
        JButton[] normalButtons = {btnTTKH, btnBan, btnKhong}; // C√°c n√∫t m√†u xanh r√™u
        fixButtonSize(btnAnh, 252, 301);
        // S·ª≠ d·ª•ng phi√™n b·∫£n simple theme ƒë·ªÉ kh√¥ng thay ƒë·ªïi layout
        MaQuaiTheme.applySimpleTheme(this, panels, labels, specialButtons, normalButtons);

        // Thi·∫øt l·∫≠p ri√™ng c√°c n√∫t h√¨nh ·∫£nh
        MaQuaiTheme.setupImageButtonForUI(btnKHTrongNgay, "btnKHTN");
        MaQuaiTheme.setupImageButtonForUI(btnTTKH, "btnTTKH");

        // Custom th√™m n·∫øu c·∫ßn
        jLabel2.setFont(new Font("Dialog", Font.BOLD, 14));
        jLabel6.setFont(new Font("Dialog", Font.BOLD, 14));
        jLabel8.setFont(new Font("Dialog", Font.BOLD, 14));
        jLabel8.setForeground(new Color(140, 200, 140));

        // ƒê·∫∑t k√≠ch th∆∞·ªõc frame theo t·ªâ l·ªá 9:16
        this.setSize(800, 700);
        this.setPreferredSize(new Dimension(800, 700));
        this.setResizable(false);

        // Thi·∫øt l·∫≠p ri√™ng cho n√∫t ·∫£nh (btnAnh)
        btnAnh.setBorder(BorderFactory.createEmptyBorder());
        btnAnh.setContentAreaFilled(false);
        btnAnh.setFocusPainted(false);

    }

    private void fixButtonSize(JButton button, int width, int height) {
        button.setPreferredSize(new Dimension(width, height));
        button.setMinimumSize(new Dimension(width, height));
        button.setMaximumSize(new Dimension(width, height));
        button.setSize(new Dimension(width, height));
    }

    private void setupPanelBackground(JPanel panel) {
        // ƒê·∫£m b·∫£o panel c√≥ k√≠ch th∆∞·ªõc tr∆∞·ªõc khi t·∫£i ·∫£nh
        panel.setPreferredSize(new Dimension(700, 320));

        // T·∫£i ·∫£nh n·ªÅn v·ªõi k√≠ch th∆∞·ªõc ph√π h·ª£p
        ImageIcon backgroundIcon = TaiAnhGamePlay.loadBackgroundImage(
                panel.getPreferredSize().width,
                panel.getPreferredSize().height
        );

        // T·∫°o JLabel ch·ª©a ·∫£nh n·ªÅn
        JLabel backgroundLabel = new JLabel(backgroundIcon);
        backgroundLabel.setBounds(0, 0, panel.getWidth(), panel.getHeight());

        // X√≥a layout hi·ªán t·∫°i v√† thi·∫øt l·∫≠p layout m·ªõi
        panel.setLayout(new BorderLayout());

        // Th√™m backgroundLabel v√†o panel
        panel.add(backgroundLabel, BorderLayout.CENTER);

        // ƒê·∫£m b·∫£o btnAnh hi·ªÉn th·ªã tr√™n ·∫£nh n·ªÅn
        backgroundLabel.setLayout(new OverlayLayout(backgroundLabel));
        backgroundLabel.add(btnAnh);

        // CƒÉn ch·ªânh btnAnh
        btnAnh.setAlignmentX(0.5f);
        btnAnh.setAlignmentY(0.5f);
    }

    private void loadRandomImageToButton() {
        try {
            ImageIcon randomIcon;

            if (khachHangMoiTamThoi != null) {
                String gioiTinh = khachHangMoiTamThoi.getGioiTinh();
                randomIcon = TaiAnhGamePlay.loadImageByGender(
                        gioiTinh,
                        btnAnh.getWidth(),
                        btnAnh.getHeight());
            } else {
                randomIcon = TaiAnhGamePlay.loadRandomImage(
                        btnAnh.getWidth(),
                        btnAnh.getHeight());
            }

            if (randomIcon != null) {
                fixButtonSize(btnAnh, 252, 301);
                btnAnh.setIcon(randomIcon);

                btnAnh.revalidate();
                btnAnh.repaint();
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, e.getMessage(), "L·ªói", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void initGameTimeManager() {
        gameTimeManager = new GameTimeManager();

        // Thi·∫øt l·∫≠p listener ƒë·ªÉ c·∫≠p nh·∫≠t UI khi th·ªùi gian thay ƒë·ªïi
        gameTimeManager.setUpdateListener(new GameTimeManager.TimeUpdateListener() {
            @Override
            public void onTimeUpdate(String timeString, int currentHour, boolean isNight) {
                SwingUtilities.invokeLater(() -> {
                    jLabel4.setText(timeString);
                    // C√≥ th·ªÉ th√™m hi·ªáu ·ª©ng ƒë√™m n·∫øu c·∫ßn
                    if (isNight) {
                        // √Åp d·ª•ng hi·ªáu ·ª©ng ƒë√™m cho UI
                    }
                });
            }
        });
        gameTimeManager.setDayEndListener(new GameTimeManager.DayEndListener() {
            @Override
            public void onDayEnd() {
                SwingUtilities.invokeLater(() -> {
                    endDaySequence();
                });
            }
        });

        // B·∫Øt ƒë·∫ßu ƒë·∫øm th·ªùi gian
        gameTimeManager.startTimer();
    }

    private void endDaySequence() {
        // Hi·ªÉn th·ªã th√¥ng b√°o k·∫øt th√∫c ng√†y
        JOptionPane.showMessageDialog(this,
                "ƒê√£ h·∫øt ng√†y! C·ª≠a h√†ng ƒë√≥ng c·ª≠a.",
                "K·∫øt th√∫c ng√†y",
                JOptionPane.INFORMATION_MESSAGE);
        TextFileStorage.savePlayerData(playerData);

        // Hi·ªÉn th·ªã b·∫£ng t·ªïng k·∫øt ng√†y
        showDaySummary();

        // üî• S·ª¨A QUAN TR·ªåNG: KI·ªÇM TRA V√Ä CH·∫†Y K·ªäCH B·∫¢N TR∆Ø·ªöC KHI C·∫¨P NH·∫¨T S·ªê NG√ÄY
        kichBanNgayDau.startKichBan();

        // üî• Sau khi ch·∫°y k·ªãch b·∫£n (n·∫øu c√≥), m·ªõi c·∫≠p nh·∫≠t s·ªë ng√†y ti·∫øp theo
        int currentDay = gameTimeManager.getCurrentDay();
        KichBanNgayDauTien.updateDayCount(currentDay + 1); // C·∫≠p nh·∫≠t cho ng√†y ti·∫øp theo

        // Chu·∫©n b·ªã cho ng√†y m·ªõi
        prepareForNewDay();
    }

    private void showDaySummary() {
        JOptionPane.showMessageDialog(this,
                "T·ªïng k·∫øt ng√†y:\n"
                + "Doanh thu: " + calculateDailyRevenue() + "\n"
                + "ƒêi·ªÉm tinh th·∫ßn: " + playerData.mentalPoints,
                "T·ªïng k·∫øt ng√†y",
                JOptionPane.INFORMATION_MESSAGE);
    }

    private void prepareForNewDay() {
        gameTimeManager.restartTimer();
        updateUI();
    }

    private int calculateDailyRevenue() {
        return 0;
    }

    public void tamDungTimer() {
        if (gameTimeManager != null && gameTimeManager.isTimerRunning()) {
            gameTimeManager.stopTimer();
        }
    }

    public void tiepTucTimer() {
        if (gameTimeManager != null && !gameTimeManager.isTimerRunning()) {
            gameTimeManager.startTimer();
        }
    }
}
